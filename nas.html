<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X - Personal Stock Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/nas-manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="X-Stock">
    <link rel="apple-touch-icon" href="/icons/stock-icon-192x192.png">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
        }
        html, body {
            overflow: hidden;
            height: 100%;
        }
        .main-content {
            height: calc(100vh - 4rem); /* Adjust based on nav bar height */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        .nav-item.active {
            color: #3b82f6; /* Tailwind blue-500 */
            border-top-color: #3b82f6;
        }
        .nav-item {
            border-top: 2px solid transparent;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 0.5rem;
        }
        .tradingview-fullscreen-modal .modal-content {
            width: 100%;
            height: 100%;
            max-width: none;
            border-radius: 0;
            padding: 0;
        }
        .tradingview-fullscreen-modal iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Styles for summary cards (dark theme inspired by image) */
        .summary-card { /* For top dashboard cards */
            background-color: #1f2937; /* Tailwind gray-800 */
            color: #f3f4f6; /* Tailwind gray-100 */
            padding: 1.5rem; /* p-6 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
        }
        .summary-card-title {
            font-size: 0.875rem; /* text-sm */
            color: #9ca3af; /* Tailwind gray-400 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        .summary-card-value {
            font-size: 2.25rem; /* text-4xl */
            font-weight: bold; /* font-bold */
            color: #ffffff; /* white */
        }
        .summary-card-currency {
            font-size: 1rem; /* text-base */
            color: #d1d5db; /* Tailwind gray-300 */
            margin-left: 0.25rem;
        }
        
        /* New styles for individual stock list items */
        .stock-list-item {
            background-color: #ffffff; /* bg-white */
            color: #1f2937; /* text-gray-800 */
            padding: 1rem; /* p-4 */
            border-radius: 0.75rem; /* rounded-xl, increased rounding */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); /* shadow-md */
            display: flex;
            align-items: center;
            margin-bottom: 1rem; /* space between items */
        }
        .stock-icon-placeholder {
            width: 3rem; /* w-12 */
            height: 3rem; /* h-12 */
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 1rem; /* mr-4 */
            flex-shrink: 0;
        }
        .stock-info {
            flex-grow: 1;
        }
        .stock-info-title {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #111827; /* gray-900 */
        }
        .stock-info-subtitle {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* gray-500 */
        }
        .stock-value-tag {
            width: 5rem; /* w-20, increased width */
            height: 5rem; /* h-20, increased height */
            border-radius: 9999px; /* rounded-full */
            background-color: #10b981; /* emerald-500, changed to emerald for better visibility */
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin-left: 1rem; /* ml-4 */
            flex-shrink: 0;
            box-shadow: 0 4px 6px -1px rgba(16,185,129,0.3), 0 2px 4px -1px rgba(16,185,129,0.2);
        }
         .stock-value-tag .value-amount {
            font-size: 1.125rem; /* text-lg */
            font-weight: bold;
            line-height: 1.2;
        }
        .stock-value-tag .value-label {
            font-size: 0.65rem; /* text-xs, slightly smaller */
            line-height: 1;
            margin-top: 0.125rem; /* mt-0.5 */
        }
        .stock-actions {
            background-color: #f9fafb; /* gray-50 */
            padding: 0.75rem; /* p-3 */
            margin-top: 0.75rem; /* mt-3 */
            border-top: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0 0 0.75rem 0.75rem; /* rounded-b-xl */
        }

    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col h-screen">

    <main id="mainContent" class="flex-grow main-content p-0 sm:p-4 bg-white">
        <section id="summaryView" class="hidden h-full flex flex-col">
            <div class="flex-grow p-4 bg-gray-900 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-100">สรุปภาพรวมการลงทุน</h1>
                    <button onclick="window.location.href='index.html'" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150">
                        จัดการ USD
                    </button>
                </div>
                <div id="summaryDashboard" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <div class="summary-card">
                        <p class="summary-card-title">กำลังโหลดข้อมูล...</p>
                        <p class="summary-card-value">-</p>
                    </div>
                </div>
                <h2 class="text-xl font-semibold mb-4 text-gray-100">รายละเอียดหุ้นรายตัว</h2>
                <div id="summaryStockDetails" class="space-y-0"> <p class="text-gray-400 p-4 text-center">กำลังโหลดข้อมูลหุ้น...</p>
                </div>
            </div>
        </section>

        <section id="graphView" class="hidden h-full flex flex-col p-4">
            <h1 class="text-2xl font-bold mb-4 text-slate-700">กราฟหุ้น (TradingView)</h1>
            <div class="mb-4 flex space-x-2">
                <input type="text" id="tvSymbolInput" placeholder="เช่น AAPL, TSLA, BTCUSD" class="flex-grow p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <button id="tvLoadSymbolBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150">โหลดกราฟ</button>
                <button id="tvFullscreenBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150">เต็มจอ</button>
            </div>
            <div id="tradingViewWidgetContainer" class="flex-grow border border-slate-300 rounded-md shadow-inner overflow-hidden bg-slate-50">
                <p class="p-4 text-slate-500 text-center">กรุณาใส่ชื่อหุ้นและกด "โหลดกราฟ"</p>
            </div>
        </section>

        <section id="recordView" class="hidden p-4">
            <h1 class="text-2xl font-bold mb-4 text-slate-700">บันทึกรายการซื้อหุ้น</h1>
            <form id="recordForm" class="space-y-4">
                <div>
                    <label for="recordDate" class="block text-sm font-medium text-slate-700">วันที่ซื้อ:</label>
                    <input type="date" id="recordDate" name="date" required
                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="recordStockSymbol" class="block text-sm font-medium text-slate-700">ชื่อหุ้น (Symbol):</label>
                    <input type="text" id="recordStockSymbol" name="stockSymbol" placeholder="เช่น AAPL" required
                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="recordQuantity" class="block text-sm font-medium text-slate-700">จำนวนหุ้น:</label>
                    <input type="number" id="recordQuantity" name="quantity" step="any" placeholder="10" required
                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="recordTotalTHB" class="block text-sm font-medium text-slate-700">เงินบาทรวม (สำหรับรายการนี้):</label>
                    <input type="number" id="recordTotalTHB" name="totalTHB" step="any" placeholder="50000" required
                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="recordUsdRate" class="block text-sm font-medium text-slate-700">Rate THB/USD (ณ วันซื้อ, ถ้ามี):</label>
                    <input type="number" id="recordUsdRate" name="usdExchangeRateAtPurchase" step="any" placeholder="35.50"
                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150">บันทึกรายการ</button>
            </form>
        </section>

        <section id="historyView" class="hidden p-4">
            <h1 class="text-2xl font-bold mb-4 text-slate-700">ประวัติการซื้อ</h1>
            <div class="mb-4">
                <input type="text" id="historySearchInput" placeholder="ค้นหาตามชื่อหุ้นหรือวันที่ (YYYY-MM-DD)"
                    class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div id="historyTableContainer" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 border border-slate-300 rounded-md shadow">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">วันที่</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ชื่อหุ้น</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">จำนวน</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">เงินบาทรวม</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Rate THB/USD</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">การกระทำ</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="bg-white divide-y divide-slate-200">
                        <tr><td colspan="6" class="text-center p-4 text-slate-500">ยังไม่มีประวัติการซื้อขาย</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="settingsView" class="hidden p-4">
            <h1 class="text-2xl font-bold mb-4 text-slate-700">ตั้งค่า</h1>
            <form id="settingsForm" class="space-y-6">
                <div>
                    <label for="settingsSheetId" class="block text-sm font-medium text-slate-700">Sheet ID (Google Sheets - จำลอง):</label>
                    <input type="text" id="settingsSheetId" name="sheetId" placeholder="กรอก Sheet ID ของคุณ"
                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="border-t border-slate-200 pt-4">
                    <h2 class="text-lg font-semibold mb-2 text-slate-700">Rate เป้าหมายของหุ้นแต่ละตัว (THB/หุ้น):</h2>
                    <div id="stockTargetRatesContainer" class="space-y-2">
                        <p class="text-sm text-slate-500">ยังไม่มีการตั้งค่า Rate เป้าหมาย</p>
                    </div>
                    <div class="mt-2 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="text" id="newTargetStockSymbol" placeholder="ชื่อหุ้น (Symbol)"
                            class="w-full sm:w-1/2 p-2 border border-slate-300 rounded-md shadow-sm">
                        <input type="number" id="newTargetStockRate" placeholder="Rate เป้าหมาย (THB)"
                            class="w-full sm:w-1/2 p-2 border border-slate-300 rounded-md shadow-sm">
                        <button type="button" id="addStockTargetRateBtn"
                            class="w-full sm:w-auto bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm">เพิ่ม</button>
                    </div>
                </div>
                <div class="border-t border-slate-200 pt-4">
                    <h2 class="text-lg font-semibold mb-2 text-slate-700">Rate แลกเปลี่ยนเป้าหมายของหุ้นแต่ละตัว (THB/USD):</h2>
                    <div id="stockTargetExchangeRatesContainer" class="space-y-2">
                        <p class="text-sm text-slate-500">ยังไม่มีการตั้งค่า Rate แลกเปลี่ยนเป้าหมาย</p>
                    </div>
                    <div class="mt-2 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="text" id="newTargetStockSymbolUsd" placeholder="ชื่อหุ้น (Symbol)"
                            class="w-full sm:w-1/2 p-2 border border-slate-300 rounded-md shadow-sm">
                        <input type="number" id="newTargetUsdRate" placeholder="Rate เป้าหมาย (THB/USD)" step="any"
                            class="w-full sm:w-1/2 p-2 border border-slate-300 rounded-md shadow-sm">
                        <button type="button" id="addStockTargetUsdRateBtn"
                            class="w-full sm:w-auto bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm">เพิ่ม</button>
                    </div>
                </div>
                <button type="submit"
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150">บันทึกการตั้งค่า</button>
            </form>
        </section>
    </main>

    <nav class="bg-slate-50 border-t border-slate-200 shadow-md h-16 flex items-center justify-around sticky bottom-0 z-50">
        <button data-view="summaryView" class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-slate-600 hover:bg-slate-100 transition duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            <span class="text-xs">สรุป</span>
        </button>
        <button data-view="graphView" class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-slate-600 hover:bg-slate-100 transition duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
            <span class="text-xs">กราฟ</span>
        </button>
        <button data-view="recordView" class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-slate-600 hover:bg-slate-100 transition duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
            <span class="text-xs">บันทึก</span>
        </button>
        <button data-view="historyView" class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-slate-600 hover:bg-slate-100 transition duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span class="text-xs">ประวัติ</span>
        </button>
        <button data-view="settingsView" class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-slate-600 hover:bg-slate-100 transition duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            <span class="text-xs">ตั้งค่า</span>
        </button>
    </nav>

    <div id="messageModal" class="modal">
        <div class="modal-content text-center">
            <p id="modalMessageText" class="text-lg mb-4"></p>
            <button id="modalCloseBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-md shadow-md">ตกลง</button>
        </div>
    </div>

    <div id="tradingViewFullscreenModal" class="modal tradingview-fullscreen-modal">
        <div class="modal-content relative">
            <button id="closeTradingViewFullscreenBtn" class="absolute top-2 right-2 z-10 bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="tradingViewFullscreenContent" class="w-full h-full"></div>
        </div>
    </div>


    <script>
        // --- Application State & Data ---
        let transactions = [];
        let settings = {
            sheetId: '',
            targetCurrency: 'THB', // Default to THB, no longer user configurable via input
            stockTargetRates: {}, // Target price per share in THB
            stockTargetExchangeRates: {} // Target THB/USD exchange rate
        };
        let useMockData = false;

        // --- DOM Elements ---
        const mainContent = document.getElementById('mainContent');
        const navItems = document.querySelectorAll('.nav-item');
        const views = {
            summaryView: document.getElementById('summaryView'),
            graphView: document.getElementById('graphView'),
            recordView: document.getElementById('recordView'),
            historyView: document.getElementById('historyView'),
            settingsView: document.getElementById('settingsView')
        };
        const recordForm = document.getElementById('recordForm');
        const settingsForm = document.getElementById('settingsForm');
        const historyTableBody = document.getElementById('historyTableBody');
        const historySearchInput = document.getElementById('historySearchInput');
        
        const summaryDashboard = document.getElementById('summaryDashboard');
        const summaryStockDetails = document.getElementById('summaryStockDetails');

        const stockTargetRatesContainer = document.getElementById('stockTargetRatesContainer');
        const addStockTargetRateBtn = document.getElementById('addStockTargetRateBtn');
        const stockTargetExchangeRatesContainer = document.getElementById('stockTargetExchangeRatesContainer');
        const addStockTargetUsdRateBtn = document.getElementById('addStockTargetUsdRateBtn');

        const tvSymbolInput = document.getElementById('tvSymbolInput');
        const tvLoadSymbolBtn = document.getElementById('tvLoadSymbolBtn');
        const tvFullscreenBtn = document.getElementById('tvFullscreenBtn');
        const tradingViewWidgetContainer = document.getElementById('tradingViewWidgetContainer');
        
        const messageModal = document.getElementById('messageModal');
        const modalMessageText = document.getElementById('modalMessageText');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        const tradingViewFullscreenModal = document.getElementById('tradingViewFullscreenModal');
        const tradingViewFullscreenContent = document.getElementById('tradingViewFullscreenContent');
        const closeTradingViewFullscreenBtn = document.getElementById('closeTradingViewFullscreenBtn');

        // Color mapping for stock icons
        const stockIconColors = [
            'bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 
            'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500'
        ];
        let stockColorMap = {};
        let nextColorIndex = 0;

        function getStockIconColor(symbol) {
            if (!stockColorMap[symbol]) {
                stockColorMap[symbol] = stockIconColors[nextColorIndex % stockIconColors.length];
                nextColorIndex++;
            }
            return stockColorMap[symbol];
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocalStorage(); 
            
            if (transactions.length === 0) {
                useMockData = true;
                loadMockData(); 
            } else {
                useMockData = false;
            }

            navigateTo('summaryView'); 
            renderHistoryTable();
            renderSummary();
            renderSettingsForm();
            renderStockTargetRates(); // Render THB target rates
            renderStockTargetExchangeRates(); // Render USD exchange target rates

            navItems.forEach(item => {
                item.addEventListener('click', () => navigateTo(item.dataset.view));
            });

            recordForm.addEventListener('submit', handleRecordSubmit);
            settingsForm.addEventListener('submit', handleSettingsSubmit);
            addStockTargetRateBtn.addEventListener('click', handleAddStockTargetRate);
            addStockTargetUsdRateBtn.addEventListener('click', handleAddStockTargetUsdRate); // New listener for USD target rate
            historySearchInput.addEventListener('input', () => renderHistoryTable(historySearchInput.value.trim()));
            
            tvLoadSymbolBtn.addEventListener('click', loadTradingViewWidget);
            tvFullscreenBtn.addEventListener('click', openTradingViewFullscreen);
            closeTradingViewFullscreenBtn.addEventListener('click', closeTradingViewFullscreen);

            modalCloseBtn.addEventListener('click', closeModal);
            window.addEventListener('click', (event) => {
                if (event.target == messageModal) closeModal();
                if (event.target == tradingViewFullscreenModal) closeTradingViewFullscreen();
            });
            document.getElementById('recordDate').valueAsDate = new Date();

            // Service Worker Registration for nas.html
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/nas-service-worker.js')
                        .then(registration => {
                            console.log('nas-service-worker registered:', registration);
                        })
                        .catch(error => {
                            console.error('nas-service-worker registration failed:', error);
                        });
                });
            }
        });

        // --- Navigation ---
        function navigateTo(viewId) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewId]) {
                views[viewId].classList.remove('hidden');
                 // For summaryView, the scrolling content is inside a nested div
                if (viewId === 'summaryView') {
                    const summaryContentScroller = views[viewId].querySelector('.overflow-y-auto');
                    if (summaryContentScroller) summaryContentScroller.scrollTop = 0;
                } else {
                    mainContent.scrollTop = 0; 
                }
            }
            navItems.forEach(item => {
                item.classList.remove('active', 'text-blue-500', 'border-blue-500');
                item.classList.add('text-slate-600');
                if (item.dataset.view === viewId) {
                    item.classList.add('active', 'text-blue-500', 'border-blue-500');
                    item.classList.remove('text-slate-600');
                }
            });
        }

        // --- Data Persistence & Mock Data ---
        function loadMockData() {
            transactions = [
                { id: 'mock1', date: '2023-01-15', stockSymbol: 'AAPL', quantity: 10, totalTHB: 50000, usdExchangeRateAtPurchase: 33.50 },
                { id: 'mock2', date: '2023-02-20', stockSymbol: 'MSFT', quantity: 5, totalTHB: 45000, usdExchangeRateAtPurchase: 33.80 },
                { id: 'mock3', date: '2023-03-10', stockSymbol: 'AAPL', quantity: 5, totalTHB: 26000, usdExchangeRateAtPurchase: 34.10 },
                { id: 'mock4', date: '2023-04-05', stockSymbol: 'GOOGL', quantity: 7, totalTHB: 70000, usdExchangeRateAtPurchase: 34.00 },
                { id: 'mock5', date: '2023-05-12', stockSymbol: 'TSLA', quantity: 3, totalTHB: 20000, usdExchangeRateAtPurchase: 34.20 }
            ];
            settings = {
                sheetId: 'mockSheetId123',
                targetCurrency: 'THB', // Defaulted
                stockTargetRates: {
                    'AAPL': (170 * 34.5),
                    'MSFT': (300 * 34.5),
                    'GOOGL': (120 * 34.5),
                    'TSLA': (200 * 34.5)
                },
                stockTargetExchangeRates: { // Mock target exchange rates
                    'AAPL': 34.00,
                    'MSFT': 33.50,
                    'GOOGL': 34.10,
                    'TSLA': 34.00
                }
            };
            // Reset color map for mock data consistency
            stockColorMap = {};
            nextColorIndex = 0;
            console.log("Mock data loaded for summary view.");
        }

        function saveDataToLocalStorage() {
            if (!useMockData || (useMockData && transactions.some(tx => !tx.id.startsWith('mock')))) {
                 localStorage.setItem('stockTrackerTransactions', JSON.stringify(transactions));
                 localStorage.setItem('stockTrackerSettings', JSON.stringify(settings));
                 localStorage.setItem('stockTrackerColorMap', JSON.stringify(stockColorMap)); // Save color map
                 localStorage.setItem('stockTrackerNextColorIndex', nextColorIndex.toString()); // Save next color index
                 useMockData = false;
            }
        }

        function loadDataFromLocalStorage() {
            const storedTransactions = localStorage.getItem('stockTrackerTransactions');
            if (storedTransactions) {
                transactions = JSON.parse(storedTransactions);
            }
            const storedSettings = localStorage.getItem('stockTrackerSettings');
            if (storedSettings) {
                settings = JSON.parse(storedSettings);
                settings.stockTargetRates = settings.stockTargetRates || {};
                settings.stockTargetExchangeRates = settings.stockTargetExchangeRates || {}; // Initialize new setting
            } else {
                // If no settings are stored, initialize with default empty objects
                settings.stockTargetRates = {};
                settings.stockTargetExchangeRates = {};
            }
            // Ensure targetCurrency is always 'THB' if it was removed from settings
            if (!settings.targetCurrency) {
                settings.targetCurrency = 'THB';
            }

            const storedColorMap = localStorage.getItem('stockTrackerColorMap');
            if (storedColorMap) {
                stockColorMap = JSON.parse(storedColorMap);
            }
            const storedNextColorIndex = localStorage.getItem('stockTrackerNextColorIndex');
            if (storedNextColorIndex) {
                nextColorIndex = parseInt(storedNextColorIndex, 10);
            }
        }
        
        // --- Modal Functions ---
        function showModal(message) {
            modalMessageText.textContent = message;
            messageModal.style.display = 'flex';
        }

        function closeModal() {
            messageModal.style.display = 'none';
        }

        // --- TradingView Widget ---
        let currentTradingViewSymbol = '';
        function loadTradingViewWidget() {
            const symbol = tvSymbolInput.value.trim().toUpperCase() || 'AAPL';
            currentTradingViewSymbol = symbol;
            const widgetHtml = `
                <iframe
                    id="tradingview-iframe" style="width: 100%; height: 100%;" frameborder="0" allowtransparency="true" scrolling="no"
                    src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_widget&symbol=${symbol}&interval=D&symboledit=1&saveimage=1&toolbarbg=f1f3f6&studies=[]&theme=light&style=1&timezone=Asia%2FBangkok&locale=th&utm_source=localhost&utm_medium=widget_new&utm_campaign=chart&utm_term=${symbol}">
                </iframe>`;
            tradingViewWidgetContainer.innerHTML = widgetHtml;
        }

        function openTradingViewFullscreen() {
            if (!currentTradingViewSymbol && !tvSymbolInput.value.trim()) {
                showModal('กรุณาโหลดกราฟของหุ้นที่ต้องการก่อนเข้าโหมดเต็มจอ');
                return;
            }
            const symbolToLoad = currentTradingViewSymbol || tvSymbolInput.value.trim().toUpperCase() || 'AAPL';
             const fullscreenWidgetHtml = `
                <iframe style="width: 100%; height: 100%;" frameborder="0" allowtransparency="true" scrolling="no"
                    src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_fullscreen_widget&symbol=${symbolToLoad}&interval=D&symboledit=1&saveimage=1&toolbarbg=f1f3f6&studies=[]&theme=light&style=1&timezone=Asia%2FBangkok&enabled_features=['header_fullscreen_button']&locale=th&utm_source=localhost&utm_medium=widget_new&utm_campaign=chart&utm_term=${symbolToLoad}">
                </iframe>`;
            tradingViewFullscreenContent.innerHTML = fullscreenWidgetHtml;
            tradingViewFullscreenModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeTradingViewFullscreen() {
            tradingViewFullscreenModal.style.display = 'none';
            tradingViewFullscreenContent.innerHTML = '';
            document.body.style.overflow = '';
        }

        // --- Record Form Handling ---
        function handleRecordSubmit(event) {
            event.preventDefault();
            if (useMockData && transactions.every(tx => tx.id.startsWith('mock'))) {
                transactions = [];
                useMockData = false;
                stockColorMap = {}; // Reset color map when real data starts
                nextColorIndex = 0;
            }
            const formData = new FormData(recordForm);
            const transaction = {
                id: Date.now().toString(),
                date: formData.get('date'),
                stockSymbol: formData.get('stockSymbol').toUpperCase().trim(),
                quantity: parseFloat(formData.get('quantity')),
                totalTHB: parseFloat(formData.get('totalTHB')),
                usdExchangeRateAtPurchase: formData.get('usdExchangeRateAtPurchase') ? parseFloat(formData.get('usdExchangeRateAtPurchase')) : null,
            };

            if (!transaction.date || !transaction.stockSymbol || isNaN(transaction.quantity) || transaction.quantity <= 0 || isNaN(transaction.totalTHB) || transaction.totalTHB <= 0) {
                showModal('กรุณากรอกข้อมูลให้ถูกต้อง: วันที่, ชื่อหุ้น, จำนวนหุ้น และเงินบาทรวมต้องมากกว่า 0');
                return;
            }

            transactions.push(transaction);
            saveDataToLocalStorage();
            renderHistoryTable();
            renderSummary();
            recordForm.reset();
            document.getElementById('recordDate').valueAsDate = new Date();
            showModal('บันทึกรายการเรียบร้อยแล้ว');
            navigateTo('historyView');
        }

        // --- History Table Rendering & Actions ---
        function renderHistoryTable(searchTerm = '') {
            historyTableBody.innerHTML = '';
            const currentTransactions = useMockData && transactions.length > 0 && transactions.every(tx => tx.id.startsWith('mock')) ? transactions : transactions.filter(tx => !tx.id.startsWith('mock'));
            
            const displayTransactions = currentTransactions.filter(tx => {
                const searchLower = searchTerm.toLowerCase();
                return tx.stockSymbol.toLowerCase().includes(searchLower) || tx.date.includes(searchTerm);
            }).sort((a, b) => new Date(b.date) - new Date(a.date));

            if (displayTransactions.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-slate-500">${useMockData && transactions.length > 0 ? 'ข้อมูลตัวอย่าง (Mock Data)' : 'ไม่พบรายการที่ตรงกัน หรือยังไม่มีประวัติการซื้อขาย'}</td></tr>`;
                return;
            }

            displayTransactions.forEach(tx => {
                const row = historyTableBody.insertRow();
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700">${tx.date}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${tx.stockSymbol}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700">${tx.quantity.toLocaleString()}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700">${tx.totalTHB.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700">${tx.usdExchangeRateAtPurchase ? tx.usdExchangeRateAtPurchase.toFixed(2) : '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm space-x-2">
                        <button onclick="editTransaction('${tx.id}')" class="text-blue-600 hover:text-blue-800 font-medium ${tx.id.startsWith('mock') ? 'opacity-50 cursor-not-allowed' : ''}" ${tx.id.startsWith('mock') ? 'disabled' : ''}>แก้ไข</button>
                        <button onclick="confirmDeleteTransaction('${tx.id}')" class="text-red-600 hover:text-red-800 font-medium ${tx.id.startsWith('mock') ? 'opacity-50 cursor-not-allowed' : ''}" ${tx.id.startsWith('mock') ? 'disabled' : ''}>ลบ</button>
                    </td>
                `;
            });
        }
        
        function confirmDeleteTransaction(transactionId) {
            if (transactionId.startsWith('mock')) {
                showModal('ไม่สามารถลบข้อมูลตัวอย่างได้');
                return;
            }
            const confirmation = window.prompt("พิมพ์ 'DELETE' เพื่อยืนยันการลบรายการนี้:");
            if (confirmation === "DELETE") {
                 deleteTransaction(transactionId);
            } else if (confirmation !== null) {
                showModal("การลบถูกยกเลิก คำยืนยันไม่ถูกต้อง");
            }
        }

        function deleteTransaction(transactionId) {
            const deletedTx = transactions.find(tx => tx.id === transactionId);
            transactions = transactions.filter(tx => tx.id !== transactionId);
            // Optional: if you want colors to be reassigned if all stocks of a certain symbol are removed
            // you might need to rebuild stockColorMap or handle it more dynamically.
            // For simplicity, colors once assigned are kept unless explicitly reset (e.g. on clearing all data).
            saveDataToLocalStorage();
            renderHistoryTable();
            renderSummary();
            showModal('ลบรายการเรียบร้อยแล้ว');
        }

        function editTransaction(transactionId) {
             if (transactionId.startsWith('mock')) {
                showModal('ไม่สามารถแก้ไขข้อมูลตัวอย่างได้');
                return;
            }
            const transactionToEdit = transactions.find(tx => tx.id === transactionId);
            if (!transactionToEdit) {
                showModal('ไม่พบรายการที่ต้องการแก้ไข');
                return;
            }
            document.getElementById('recordDate').value = transactionToEdit.date;
            document.getElementById('recordStockSymbol').value = transactionToEdit.stockSymbol;
            document.getElementById('recordQuantity').value = transactionToEdit.quantity;
            document.getElementById('recordTotalTHB').value = transactionToEdit.totalTHB;
            document.getElementById('recordUsdRate').value = transactionToEdit.usdExchangeRateAtPurchase || '';
            
            deleteTransaction(transactionId);
            showModal(`ข้อมูลของ ${transactionToEdit.stockSymbol} ถูกโหลดในฟอร์มแล้ว กรุณาแก้ไขและกดบันทึกอีกครั้ง (รายการเดิมถูกลบแล้ว)`);
            navigateTo('recordView');
        }

        // --- Settings Form Handling ---
        function renderSettingsForm() {
            document.getElementById('settingsSheetId').value = settings.sheetId;
            // Removed settingsTargetCurrency as per user request
            // document.getElementById('settingsTargetCurrency').value = settings.targetCurrency;
        }

        function handleSettingsSubmit(event) {
            event.preventDefault();
            const formData = new FormData(settingsForm);
            settings.sheetId = formData.get('sheetId');
            // Removed settingsTargetCurrency as per user request
            // settings.targetCurrency = formData.get('targetCurrency');
            saveDataToLocalStorage();
            renderSummary();
            showModal('บันทึกการตั้งค่าเรียบร้อยแล้ว');
        }

        function renderStockTargetRates() {
            stockTargetRatesContainer.innerHTML = '';
            if (Object.keys(settings.stockTargetRates).length === 0) {
                stockTargetRatesContainer.innerHTML = '<p class="text-sm text-slate-500">ยังไม่มีการตั้งค่า Rate เป้าหมาย</p>';
                return;
            }
            for (const symbol in settings.stockTargetRates) {
                const rate = settings.stockTargetRates[symbol];
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-slate-50 rounded-md border border-slate-200';
                div.innerHTML = `
                    <span class="font-medium text-slate-700">${symbol}:</span>
                    <span class="text-slate-600">${parseFloat(rate).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ${settings.targetCurrency}</span>
                    <button onclick="removeStockTargetRate('${symbol}')" class="text-red-500 hover:text-red-700 text-sm font-medium">ลบ</button>
                `;
                stockTargetRatesContainer.appendChild(div);
            }
        }

        function handleAddStockTargetRate() {
            const symbolInput = document.getElementById('newTargetStockSymbol');
            const rateInput = document.getElementById('newTargetStockRate');
            const symbol = symbolInput.value.toUpperCase().trim();
            const rate = parseFloat(rateInput.value);

            if (symbol && !isNaN(rate) && rate > 0) {
                settings.stockTargetRates[symbol] = rate;
                saveDataToLocalStorage();
                renderStockTargetRates();
                renderSummary();
                symbolInput.value = '';
                rateInput.value = '';
                showModal(`เพิ่ม Rate เป้าหมายสำหรับ ${symbol} เรียบร้อยแล้ว`);
            } else {
                showModal('กรุณากรอกชื่อหุ้นและ Rate เป้าหมายให้ถูกต้อง');
            }
        }

        function removeStockTargetRate(symbol) {
            const confirmation = window.prompt(`พิมพ์ '${symbol}' เพื่อยืนยันการลบ Rate เป้าหมายนี้:`);
            if (confirmation === symbol) {
                delete settings.stockTargetRates[symbol];
                saveDataToLocalStorage();
                renderStockTargetRates();
                renderSummary();
                showModal(`ลบ Rate เป้าหมายสำหรับ ${symbol} เรียบร้อยแล้ว`);
            } else if (confirmation !== null) {
                showModal("การลบถูกยกเลิก คำยืนยันไม่ถูกต้อง");
            }
        }

        function renderStockTargetExchangeRates() {
            stockTargetExchangeRatesContainer.innerHTML = '';
            if (Object.keys(settings.stockTargetExchangeRates).length === 0) {
                stockTargetExchangeRatesContainer.innerHTML = '<p class="text-sm text-slate-500">ยังไม่มีการตั้งค่า Rate แลกเปลี่ยนเป้าหมาย</p>';
                return;
            }
            for (const symbol in settings.stockTargetExchangeRates) {
                const rate = settings.stockTargetExchangeRates[symbol];
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-slate-50 rounded-md border border-slate-200';
                div.innerHTML = `
                    <span class="font-medium text-slate-700">${symbol}:</span>
                    <span class="text-slate-600">${parseFloat(rate).toFixed(2)} THB/USD</span>
                    <button onclick="removeStockTargetUsdRate('${symbol}')" class="text-red-500 hover:text-red-700 text-sm font-medium">ลบ</button>
                `;
                stockTargetExchangeRatesContainer.appendChild(div);
            }
        }

        function handleAddStockTargetUsdRate() {
            const symbolInput = document.getElementById('newTargetStockSymbolUsd');
            const rateInput = document.getElementById('newTargetUsdRate');
            const symbol = symbolInput.value.toUpperCase().trim();
            const rate = parseFloat(rateInput.value);

            if (symbol && !isNaN(rate) && rate > 0) {
                settings.stockTargetExchangeRates[symbol] = rate;
                saveDataToLocalStorage();
                renderStockTargetExchangeRates();
                renderSummary();
                symbolInput.value = '';
                rateInput.value = '';
                showModal(`เพิ่ม Rate แลกเปลี่ยนเป้าหมายสำหรับ ${symbol} เรียบร้อยแล้ว`);
            } else {
                showModal('กรุณากรอกชื่อหุ้นและ Rate แลกเปลี่ยนเป้าหมายให้ถูกต้อง');
            }
        }

        function removeStockTargetUsdRate(symbol) {
            const confirmation = window.prompt(`พิมพ์ '${symbol}' เพื่อยืนยันการลบ Rate แลกเปลี่ยนเป้าหมายนี้:`);
            if (confirmation === symbol) {
                delete settings.stockTargetExchangeRates[symbol];
                saveDataToLocalStorage();
                renderStockTargetExchangeRates();
                renderSummary();
                showModal(`ลบ Rate แลกเปลี่ยนเป้าหมายสำหรับ ${symbol} เรียบร้อยแล้ว`);
            } else if (confirmation !== null) {
                showModal("การลบถูกยกเลิก คำยืนยันไม่ถูกต้อง");
            }
        }

        // --- Summary Calculation and Rendering (Updated for new design) ---
        function renderSummary() {
            summaryDashboard.innerHTML = '';
            summaryStockDetails.innerHTML = '';
            // Filter transactions to display only real data if not using mock data
            const currentTransactionsToDisplay = (useMockData && transactions.every(tx => tx.id.startsWith('mock'))) ? transactions : transactions.filter(tx => !tx.id.startsWith('mock'));

            if (currentTransactionsToDisplay.length === 0 && !useMockData) {
                 summaryDashboard.innerHTML = `
                    <div class="summary-card col-span-1 sm:col-span-2">
                        <p class="summary-card-title">ภาพรวมพอร์ตการลงทุน</p>
                        <p class="text-lg text-gray-300">ยังไม่มีข้อมูลการลงทุน</p>
                        <p class="text-sm text-gray-400 mt-2">กรุณาไปที่หน้า "บันทึก" เพื่อเพิ่มรายการซื้อขายแรกของคุณ</p>
                    </div>`;
                summaryStockDetails.innerHTML = '<p class="text-gray-400 p-4 text-center">เมื่อมีข้อมูลแล้ว รายละเอียดหุ้นจะแสดงที่นี่</p>';
                return;
            }
            
            let totalInvestmentTHB = 0;
            const uniqueStockSymbols = new Set();
            const stocksData = {};

            currentTransactionsToDisplay.forEach(tx => {
                totalInvestmentTHB += tx.totalTHB;
                uniqueStockSymbols.add(tx.stockSymbol);

                if (!stocksData[tx.stockSymbol]) {
                    stocksData[tx.stockSymbol] = {
                        totalShares: 0,
                        totalTHBSpent: 0,
                        totalUsdRateWeighted: 0, // For calculating average USD rate
                        usdRateTxCount: 0 // Count transactions with USD rate
                    };
                }
                stocksData[tx.stockSymbol].totalShares += tx.quantity;
                stocksData[tx.stockSymbol].totalTHBSpent += tx.totalTHB;
                
                // Calculate weighted average for USD exchange rate
                if (tx.usdExchangeRateAtPurchase !== null && !isNaN(tx.usdExchangeRateAtPurchase)) {
                    stocksData[tx.stockSymbol].totalUsdRateWeighted += tx.usdExchangeRateAtPurchase * tx.quantity;
                    stocksData[tx.stockSymbol].usdRateTxCount += tx.quantity; // Sum quantities for weighted average
                }
            });

            // Create Dashboard Cards (Dark theme)
            const totalInvestmentCard = document.createElement('div');
            totalInvestmentCard.className = 'summary-card';
            totalInvestmentCard.innerHTML = `
                <p class="summary-card-title">มูลค่าลงทุนรวม</p>
                <p class="summary-card-value">${totalInvestmentTHB.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}<span class="summary-card-currency">${settings.targetCurrency}</span></p>
                ${useMockData && currentTransactionsToDisplay.every(tx => tx.id.startsWith('mock')) ? '<p class="text-xs text-sky-400 mt-1">(ข้อมูลตัวอย่าง)</p>' : ''}
            `;
            summaryDashboard.appendChild(totalInvestmentCard);

            const uniqueStocksCard = document.createElement('div');
            uniqueStocksCard.className = 'summary-card';
            uniqueStocksCard.innerHTML = `
                <p class="summary-card-title">จำนวนหุ้นที่ถือครอง</p>
                <p class="summary-card-value">${uniqueStockSymbols.size}<span class="summary-card-currency">ตัว</span></p>
                <p class="text-xs text-gray-400 mt-1">หุ้นที่ไม่ซ้ำกัน</p>
            `;
            summaryDashboard.appendChild(uniqueStocksCard);
            
            // Create Individual Stock List Items (Light cards on dark section background)
            if (Object.keys(stocksData).length === 0) {
                 summaryStockDetails.innerHTML = `<p class="text-gray-400 p-4 text-center">${useMockData ? 'ข้อมูลหุ้นตัวอย่างกำลังโหลด...' : 'ยังไม่มีข้อมูลหุ้นรายตัว'}</p>`;
            }

            Object.keys(stocksData).sort().forEach(symbol => {
                const data = stocksData[symbol];
                const averageCostPerShare = data.totalShares > 0 ? data.totalTHBSpent / data.totalShares : 0;
                const averageUsdRateAtPurchase = data.usdRateTxCount > 0 ? data.totalUsdRateWeighted / data.usdRateTxCount : 0;
                const targetRate = settings.stockTargetRates[symbol] || 0; // Target price per share in THB
                const targetUsdExchangeRate = settings.stockTargetExchangeRates[symbol] || 0; // Target THB/USD exchange rate
                const iconColor = getStockIconColor(symbol);

                // Format totalTHBSpent for the tag (e.g., 76K, 1.2M)
                let displayValue = '';
                if (data.totalTHBSpent >= 1000000) {
                    displayValue = (data.totalTHBSpent / 1000000).toFixed(1) + 'M';
                } else if (data.totalTHBSpent >= 1000) {
                    displayValue = (data.totalTHBSpent / 1000).toFixed(0) + 'K';
                } else {
                    displayValue = data.totalTHBSpent.toFixed(0);
                }


                const stockItemContainer = document.createElement('div');
                stockItemContainer.className = 'stock-list-item-container mb-3'; // Add margin here

                const stockDiv = document.createElement('div');
                stockDiv.className = 'stock-list-item';
                stockDiv.innerHTML = `
                    <div class="stock-icon-placeholder ${iconColor}">
                        ${symbol.charAt(0)}
                    </div>
                    <div class="stock-info">
                        <h3 class="stock-info-title">${symbol}</h3>
                        <p class="text-sm text-gray-500">จำนวนหุ้น: ${data.totalShares.toLocaleString()}</p>
                        <p class="text-sm text-gray-500">ต้นทุนเฉลี่ย (THB/หุ้น): ${averageCostPerShare.toLocaleString(undefined, {minimumFractionDigits: 2})} ${settings.targetCurrency}</p>
                        ${averageUsdRateAtPurchase > 0 ? `<p class="text-sm text-gray-500">Rate แลกเปลี่ยนเฉลี่ย (THB/USD): ${averageUsdRateAtPurchase.toFixed(2)}</p>` : ''}
                        ${targetRate > 0 ? `<p class="text-sm text-blue-600 font-medium">เป้าหมายราคา (THB/หุ้น): ${targetRate.toLocaleString(undefined, {minimumFractionDigits: 2})} ${settings.targetCurrency}</p>` : ''}
                        ${targetUsdExchangeRate > 0 ? `<p class="text-sm text-blue-600 font-medium">เป้าหมาย Rate แลกเปลี่ยน (THB/USD): ${targetUsdExchangeRate.toFixed(2)}</p>` : ''}
                    </div>
                    <div class="stock-value-tag">
                        <span class="value-amount">${displayValue}</span>
                        <span class="value-label">${settings.targetCurrency}</span>
                    </div>
                `;
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'stock-actions hidden'; // Initially hidden, can be toggled
                actionsDiv.innerHTML = `
                    <div class="grid grid-cols-1 gap-2">
                         <div>
                            <label for="currentMarketPrice_${symbol}" class="block text-xs font-medium text-gray-700 mb-1">Rate ปัจจุบัน (ราคาตลาด/หุ้น):</label>
                            <input type="number" id="currentMarketPrice_${symbol}" step="any" placeholder="กรอกราคาตลาด" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button onclick="calculateAdditionalPurchase('${symbol}', ${data.totalShares}, ${data.totalTHBSpent}, ${targetRate})" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm text-xs">คำนวณซื้อเพิ่ม</button>
                    </div>
                    <div id="additionalPurchaseResult_${symbol}" class="mt-2 text-xs text-gray-600"></div>
                `;
                
                stockItemContainer.appendChild(stockDiv);
                stockItemContainer.appendChild(actionsDiv);
                summaryStockDetails.appendChild(stockItemContainer);

                // Add click listener to toggle actionsDiv
                stockDiv.addEventListener('click', () => {
                    actionsDiv.classList.toggle('hidden');
                    // Scroll into view if it becomes too long
                    if (!actionsDiv.classList.contains('hidden')) {
                         setTimeout(() => actionsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
                    }
                });
            });
        }

        function calculateAdditionalPurchase(symbol, currentShares, currentTotalCost, targetAvgPrice) {
            const marketPriceInput = document.getElementById(`currentMarketPrice_${symbol}`);
            const marketPrice = parseFloat(marketPriceInput.value);
            const resultDiv = document.getElementById(`additionalPurchaseResult_${symbol}`);
            resultDiv.innerHTML = ''; // Clear previous results

            if (isNaN(marketPrice) || marketPrice <= 0) {
                resultDiv.innerHTML = '<p class="text-red-600">กรุณากรอกราคาตลาดปัจจุบันให้ถูกต้อง</p>';
                return;
            }
            if (targetAvgPrice <= 0) {
                resultDiv.innerHTML = '<p class="text-orange-600">กรุณาตั้ง Rate เป้าหมายสำหรับหุ้นนี้ในหน้า "ตั้งค่า" ก่อน</p>';
                return;
            }

            if (Math.abs(marketPrice - targetAvgPrice) < 0.001) {
                const currentAvgCost = currentShares > 0 ? currentTotalCost / currentShares : 0;
                if (Math.abs(currentAvgCost - targetAvgPrice) < 0.001) {
                     resultDiv.innerHTML = `<p class="text-green-600">ต้นทุนเฉลี่ยและราคาตลาดปัจจุบันเท่ากับ Rate เป้าหมายแล้ว ไม่จำเป็นต้องซื้อเพิ่ม</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="text-orange-600">ราคาตลาดปัจจุบันเท่ากับ Rate เป้าหมาย ไม่สามารถใช้สูตรนี้เพื่อปรับ Rate เฉลี่ยได้โดยตรง</p>`;
                }
                return;
            }
            
            const amountTHBtoBuy = (targetAvgPrice * currentShares - currentTotalCost) * marketPrice / (marketPrice - targetAvgPrice);

            let message = '';
            if (amountTHBtoBuy > 0) {
                const newShares = amountTHBtoBuy / marketPrice;
                const newTotalShares = currentShares + newShares;
                const newTotalCost = currentTotalCost + amountTHBtoBuy;
                const newAvgCost = newTotalCost / newTotalShares;

                message = `
                    <p class="text-green-700 font-semibold">หากต้องการ Rate เฉลี่ยที่ ${targetAvgPrice.toLocaleString(undefined, {minimumFractionDigits: 2})} ${settings.targetCurrency}:</p>
                    <ul class="list-disc list-inside ml-2 mt-1">
                        <li>ซื้อเพิ่ม: <strong class="font-medium">${amountTHBtoBuy.toLocaleString(undefined, {minimumFractionDigits: 2})} ${settings.targetCurrency}</strong></li>
                        <li>(ที่ราคา ${marketPrice.toLocaleString(undefined, {minimumFractionDigits: 2})} ${settings.targetCurrency}/หุ้น)</li>
                        <li>ได้หุ้นเพิ่ม: ${newShares.toLocaleString(undefined, {minimumFractionDigits: 4})} หุ้น</li>
                        <li>Rate เฉลี่ยใหม่: ${newAvgCost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ${settings.targetCurrency}</li>
                    </ul>
                `;
            } else {
                 const currentAvgCost = currentShares > 0 ? currentTotalCost / currentShares : 0;
                 if (Math.abs(currentAvgCost - targetAvgPrice) < 0.001) {
                    message = `<p class="text-green-600">ต้นทุนเฉลี่ยปัจจุบันของคุณอยู่ที่ประมาณ Rate เป้าหมายแล้ว (${currentAvgCost.toLocaleString(undefined, {minimumFractionDigits: 2})} ${settings.targetCurrency}).</p>`;
                 } else if (targetAvgPrice > currentAvgCost && marketPrice < targetAvgPrice) {
                    message = `<p class="text-orange-500">Rate เป้าหมาย (${targetAvgPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) สูงกว่าต้นทุนเฉลี่ยปัจจุบัน แต่ราคาตลาด (${marketPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) ต่ำกว่า Rate เป้าหมาย การซื้อที่ราคานี้จะทำให้ต้นทุนเฉลี่ยต่ำลง/เข้าใกล้ราคาตลาด</p`;
                 } else if (targetAvgPrice < currentAvgCost && marketPrice > targetAvgPrice) {
                    message = `<p class="text-orange-500">Rate เป้าหมาย (${targetAvgPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) ต่ำกว่าต้นทุนเฉลี่ยปัจจุบัน แต่ราคาตลาด (${marketPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) สูงกว่า Rate เป้าหมาย การซื้อที่ราคานี้จะทำให้ต้นทุนเฉลี่ยสูงขึ้น/เข้าใกล้ราคาตลาด</p>`;
                 }
                 else {
                    message = `<p class="text-orange-500">การซื้อหุ้นที่ราคาตลาดปัจจุบัน (${marketPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) อาจไม่ช่วยให้ไปถึง Rate เป้าหมาย (${targetAvgPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) ตามที่ต้องการ หรือเงื่อนไขไม่เหมาะสม</p>`;
                 }
            }
            resultDiv.innerHTML = message;
        }

    </script>
</body>
</html>
